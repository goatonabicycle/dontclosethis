<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0" />
    <title>Don't Close This</title>
    <link
      rel="stylesheet"
      href="styles.css" />
  </head>
  <body>
    <div id="game-container">
      <div class="level-indicator">Level <span id="current-level">1</span></div>
      <div id="question"></div>
      <div
        class="button-container"
        id="buttons"></div>
    </div>

    <script>
      // Game State
      let currentLevel = 1;
      let totalAttempts = 0;
      let startTime = Date.now();

      // Load saved progress
      function loadProgress() {
        const saved = localStorage.getItem("dontCloseThis");
        if (saved) {
          const data = JSON.parse(saved);
          totalAttempts = data.attempts || 0;
        }
      }

      // Save progress
      function saveProgress() {
        localStorage.setItem(
          "dontCloseThis",
          JSON.stringify({
            attempts: totalAttempts,
            highestLevel: Math.max(
              currentLevel,
              JSON.parse(
                localStorage.getItem("dontCloseThis") || '{"highestLevel":0}'
              ).highestLevel
            ),
          })
        );
      }

      // Save high score
      function saveHighScore() {
        const initials = localStorage.getItem('playerInitials') || 'AAA';
        const scores = JSON.parse(localStorage.getItem('highScores') || '[]');

        // Add new score
        scores.push({
          initials: initials,
          level: currentLevel,
          attempts: totalAttempts,
          timestamp: Date.now()
        });

        // Save back
        localStorage.setItem('highScores', JSON.stringify(scores));
      }

      // Global API for levels to use
      const game = {
        // Advance to next level
        nextLevel: function () {
          currentLevel++;
          if (currentLevel > levels.length) {
            alert(
              "Congratulations! You beat the demo. More levels coming soon..."
            );
            currentLevel = 1;
          }
          renderLevel();
        },

        // Kill the player (close the page)
        die: function () {
          totalAttempts++;
          saveProgress();

          // Save high score
          saveHighScore();

          window.close();
          setTimeout(() => {
            window.location.href = "about:blank";
          }, 100);
        },

        // Get container elements
        getContainer: () => document.getElementById("game-container"),
        getQuestionElement: () => document.getElementById("question"),
        getButtonsElement: () => document.getElementById("buttons"),
      };

      // Level Definitions - each level is a complete sandbox
      const levels = [
        // Level 1: Simple introduction
        {
          render: function () {
            game.getQuestionElement().textContent = "Welcome! Ready to begin?";
            const btn = document.createElement("button");
            btn.textContent = "YES";
            btn.onclick = game.nextLevel;
            game.getButtonsElement().appendChild(btn);
          },
        },

        // Level 2: Introduce the danger
        {
          render: function () {
            game.getQuestionElement().textContent = "Do you want to continue?";

            const yesBtn = document.createElement("button");
            yesBtn.textContent = "YES";
            yesBtn.onclick = game.nextLevel;

            const noBtn = document.createElement("button");
            noBtn.textContent = "NO";
            noBtn.onclick = game.die;

            const container = game.getButtonsElement();
            container.appendChild(yesBtn);
            container.appendChild(noBtn);
          },
        },

        // Level 3: Time pressure
        {
          render: function () {
            const questionEl = game.getQuestionElement();
            questionEl.innerHTML = "Quick! Click the GREEN button!<br><span id='timer' style='font-size: 2rem; color: red;'>3</span>";

            const container = game.getButtonsElement();

            // Create multiple buttons with random colors
            const colors = ['#ff6b6b', '#4ecdc4', '#95e1d3', '#f38181', '#51cf66'];
            const correctIndex = Math.floor(Math.random() * 5);

            for (let i = 0; i < 5; i++) {
              const btn = document.createElement("button");
              btn.textContent = "CLICK";
              btn.style.background = i === correctIndex ? '#51cf66' : colors[Math.floor(Math.random() * 4)];
              btn.onclick = i === correctIndex ? game.nextLevel : game.die;
              container.appendChild(btn);
            }

            // Countdown timer
            let timeLeft = 3;
            const timerInterval = setInterval(() => {
              timeLeft--;
              const timerEl = document.getElementById('timer');
              if (timerEl) {
                timerEl.textContent = timeLeft;
                if (timeLeft === 0) {
                  clearInterval(timerInterval);
                  game.die();
                }
              }
            }, 1000);
          },
        },

        // Level 4: Simon says
        {
          render: function () {
            game.getQuestionElement().textContent = "Simon says: Click the THIRD button";

            const container = game.getButtonsElement();

            for (let i = 1; i <= 5; i++) {
              const btn = document.createElement("button");
              btn.textContent = `Button ${i}`;
              btn.onclick = i === 3 ? game.nextLevel : game.die;
              container.appendChild(btn);
            }
          },
        },

        // Level 5: Moving target
        {
          render: function () {
            game.getQuestionElement().textContent = "Click the safe button (it's shy!)";

            const container = game.getButtonsElement();
            container.style.position = 'relative';
            container.style.height = '200px';

            const safeBtn = document.createElement("button");
            safeBtn.textContent = "SAFE";
            safeBtn.style.position = 'absolute';
            safeBtn.style.transition = 'all 0.3s ease';
            safeBtn.onclick = game.nextLevel;

            const dangerBtn = document.createElement("button");
            dangerBtn.textContent = "DANGER";
            dangerBtn.onclick = game.die;

            // Safe button runs away from cursor
            let btnX = 50;
            let btnY = 50;
            safeBtn.style.left = btnX + 'px';
            safeBtn.style.top = btnY + 'px';

            container.onmousemove = (e) => {
              const rect = container.getBoundingClientRect();
              const mouseX = e.clientX - rect.left;
              const mouseY = e.clientY - rect.top;

              const dx = mouseX - btnX;
              const dy = mouseY - btnY;
              const distance = Math.sqrt(dx * dx + dy * dy);

              if (distance < 100) {
                btnX -= dx * 0.5;
                btnY -= dy * 0.5;
                btnX = Math.max(0, Math.min(rect.width - 100, btnX));
                btnY = Math.max(0, Math.min(150, btnY));
                safeBtn.style.left = btnX + 'px';
                safeBtn.style.top = btnY + 'px';
              }
            };

            container.appendChild(safeBtn);
            container.appendChild(dangerBtn);
          },
        },

        // Level 6: Math quiz
        {
          render: function () {
            const num1 = Math.floor(Math.random() * 10) + 1;
            const num2 = Math.floor(Math.random() * 10) + 1;
            const correctAnswer = num1 + num2;

            game.getQuestionElement().textContent = `What is ${num1} + ${num2}?`;

            const container = game.getButtonsElement();

            // Generate wrong answers
            const answers = [correctAnswer];
            while (answers.length < 4) {
              const wrong = correctAnswer + Math.floor(Math.random() * 10) - 5;
              if (wrong > 0 && !answers.includes(wrong)) {
                answers.push(wrong);
              }
            }

            // Shuffle answers
            answers.sort(() => Math.random() - 0.5);

            answers.forEach(ans => {
              const btn = document.createElement("button");
              btn.textContent = ans;
              btn.onclick = ans === correctAnswer ? game.nextLevel : game.die;
              container.appendChild(btn);
            });
          },
        },

        // Level 7: Reverse psychology
        {
          render: function () {
            game.getQuestionElement().textContent = "Don't click YES. I'm serious. Click NO.";

            const yesBtn = document.createElement("button");
            yesBtn.textContent = "YES";
            yesBtn.onclick = game.nextLevel;

            const noBtn = document.createElement("button");
            noBtn.textContent = "NO";
            noBtn.onclick = game.die;

            const container = game.getButtonsElement();
            container.appendChild(yesBtn);
            container.appendChild(noBtn);
          },
        },

        // Level 8: Invisible buttons
        {
          render: function () {
            game.getQuestionElement().textContent = "One of these buttons is safe. Good luck.";

            const container = game.getButtonsElement();
            const correctIndex = Math.floor(Math.random() * 4);

            for (let i = 0; i < 4; i++) {
              const btn = document.createElement("button");
              btn.textContent = "???";
              btn.style.opacity = '0.1';
              btn.onmouseenter = function() { this.style.opacity = '1'; };
              btn.onmouseleave = function() { this.style.opacity = '0.1'; };
              btn.onclick = i === correctIndex ? game.nextLevel : game.die;
              container.appendChild(btn);
            }
          },
        },

        // Level 9: Button swap
        {
          render: function () {
            game.getQuestionElement().textContent = "Click the LEFT button";

            const container = game.getButtonsElement();

            const leftBtn = document.createElement("button");
            leftBtn.textContent = "LEFT";
            leftBtn.onclick = game.nextLevel;

            const rightBtn = document.createElement("button");
            rightBtn.textContent = "RIGHT";
            rightBtn.onclick = game.die;

            container.appendChild(leftBtn);
            container.appendChild(rightBtn);

            // Swap them after 2 seconds
            setTimeout(() => {
              container.innerHTML = '';
              container.appendChild(rightBtn);
              container.appendChild(leftBtn);
            }, 2000);
          },
        },

        // Level 10: Finale - Memory test
        {
          render: function () {
            const code = Math.floor(Math.random() * 4) + 1;

            game.getQuestionElement().innerHTML = `Remember this number: <span style="font-size: 3rem; color: red;">${code}</span>`;

            setTimeout(() => {
              game.getQuestionElement().textContent = "What was the number?";

              const container = game.getButtonsElement();

              for (let i = 1; i <= 4; i++) {
                const btn = document.createElement("button");
                btn.textContent = i;
                btn.onclick = i === code ? game.nextLevel : game.die;
                container.appendChild(btn);
              }
            }, 2000);
          },
        },
      ];

      // Render current level
      function renderLevel() {
        const level = levels[currentLevel - 1];

        // Update level indicator
        document.getElementById("current-level").textContent = currentLevel;

        // Clear containers
        game.getQuestionElement().textContent = "";
        game.getButtonsElement().innerHTML = "";

        // Let the level render itself completely
        level.render();
      }

      // Initialize game
      loadProgress();
      renderLevel();
    </script>
  </body>
</html>
