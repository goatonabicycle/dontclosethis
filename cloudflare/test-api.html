<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Tester - Don't Close This</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        h1 {
            color: #4ec9b0;
            text-align: center;
        }
        .section {
            background: #252526;
            border: 1px solid #3c3c3c;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .section h2 {
            color: #dcdcaa;
            margin-top: 0;
        }
        input, button {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            padding: 10px;
            margin: 5px;
            border-radius: 4px;
            border: 1px solid #3c3c3c;
        }
        input {
            background: #1e1e1e;
            color: #d4d4d4;
            width: 200px;
        }
        button {
            background: #0e639c;
            color: white;
            cursor: pointer;
            border: none;
            transition: background 0.2s;
        }
        button:hover {
            background: #1177bb;
        }
        button:active {
            background: #0d5a8f;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-size: 13px;
        }
        .status.success {
            background: #1e3a1e;
            border: 1px solid #4ec9b0;
            color: #4ec9b0;
        }
        .status.error {
            background: #3a1e1e;
            border: 1px solid #f48771;
            color: #f48771;
        }
        .status.info {
            background: #1e2a3a;
            border: 1px solid #569cd6;
            color: #569cd6;
        }
        pre {
            background: #1e1e1e;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            border: 1px solid #3c3c3c;
            font-size: 12px;
        }
        .label {
            color: #9cdcfe;
            display: inline-block;
            width: 150px;
        }
        #apiUrl {
            width: 400px;
        }
    </style>
</head>
<body>
    <h1>üß™ API Test Suite</h1>
    <p style="text-align: center; color: #858585;">Test your Cloudflare Worker API before integrating with the game</p>

    <!-- Configuration -->
    <div class="section">
        <h2>‚öôÔ∏è Configuration</h2>
        <label class="label">API Base URL:</label>
        <input type="text" id="apiUrl" placeholder="https://your-worker.workers.dev" />
        <button onclick="saveConfig()">Save</button>
        <div id="configStatus"></div>
    </div>

    <!-- Health Check -->
    <div class="section">
        <h2>üíö Health Check</h2>
        <button onclick="testHealth()">Test /api/health</button>
        <div id="healthStatus"></div>
        <pre id="healthResponse"></pre>
    </div>

    <!-- Submit Score -->
    <div class="section">
        <h2>üì§ Submit Score</h2>
        <div>
            <label class="label">Player Name:</label>
            <input type="text" id="submitName" value="TEST" maxlength="10" />
        </div>
        <div>
            <label class="label">Level Reached:</label>
            <input type="number" id="submitLevel" value="5" min="1" max="13" />
        </div>
        <div>
            <label class="label">Time (seconds):</label>
            <input type="number" id="submitTime" value="100" min="1" />
        </div>
        <button onclick="testSubmit()">Submit Score</button>
        <div id="submitStatus"></div>
        <pre id="submitResponse"></pre>
    </div>

    <!-- Fetch Scores -->
    <div class="section">
        <h2>üì• Fetch Leaderboard</h2>
        <div>
            <label class="label">Limit:</label>
            <input type="number" id="fetchLimit" value="10" min="1" max="50" />
        </div>
        <div>
            <label class="label">Player Name (opt):</label>
            <input type="text" id="fetchPlayer" placeholder="Leave empty for none" maxlength="10" />
        </div>
        <button onclick="testFetch()">Fetch Scores</button>
        <div id="fetchStatus"></div>
        <pre id="fetchResponse"></pre>
    </div>

    <!-- Database Query -->
    <div class="section">
        <h2>üóÑÔ∏è Quick Stats</h2>
        <button onclick="showStats()">Show Database Stats</button>
        <div id="statsStatus"></div>
        <pre id="statsDisplay"></pre>
    </div>

    <script>
        // Load saved config
        const savedUrl = localStorage.getItem('apiTestUrl') || 'https://dontclosethis-api.YOUR-SUBDOMAIN.workers.dev';
        document.getElementById('apiUrl').value = savedUrl;

        function saveConfig() {
            const url = document.getElementById('apiUrl').value.trim();
            if (!url) {
                showStatus('configStatus', 'Please enter a URL', 'error');
                return;
            }
            localStorage.setItem('apiTestUrl', url);
            showStatus('configStatus', '‚úì Configuration saved', 'success');
        }

        function getApiUrl() {
            const url = document.getElementById('apiUrl').value.trim();
            if (!url) {
                showStatus('configStatus', 'Please enter API URL first', 'error');
                throw new Error('No API URL configured');
            }
            return url;
        }

        async function testHealth() {
            const statusEl = document.getElementById('healthStatus');
            const responseEl = document.getElementById('healthResponse');

            showStatus('healthStatus', '‚è≥ Testing...', 'info');
            responseEl.textContent = '';

            try {
                const baseUrl = getApiUrl();
                const response = await fetch(`${baseUrl}/api/health`);
                const data = await response.json();

                if (response.ok) {
                    showStatus('healthStatus', '‚úì API is healthy!', 'success');
                    responseEl.textContent = JSON.stringify(data, null, 2);
                } else {
                    showStatus('healthStatus', `‚úó Error: ${response.status}`, 'error');
                    responseEl.textContent = JSON.stringify(data, null, 2);
                }
            } catch (error) {
                showStatus('healthStatus', `‚úó Failed: ${error.message}`, 'error');
                responseEl.textContent = error.stack;
            }
        }

        async function testSubmit() {
            const statusEl = document.getElementById('submitStatus');
            const responseEl = document.getElementById('submitResponse');

            const playerName = document.getElementById('submitName').value.trim().toUpperCase();
            const level = parseInt(document.getElementById('submitLevel').value);
            const timeElapsed = parseInt(document.getElementById('submitTime').value);

            if (!playerName || !level || !timeElapsed) {
                showStatus('submitStatus', '‚úó Please fill all fields', 'error');
                return;
            }

            showStatus('submitStatus', '‚è≥ Submitting...', 'info');
            responseEl.textContent = '';

            try {
                const baseUrl = getApiUrl();
                const response = await fetch(`${baseUrl}/api/scores`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        playerName,
                        level,
                        timeElapsed,
                        sessionId: 'test-session-' + Date.now()
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    showStatus('submitStatus', `‚úì Score submitted! Rank: #${data.rank}`, 'success');
                    responseEl.textContent = JSON.stringify(data, null, 2);
                } else {
                    showStatus('submitStatus', `‚úó Error: ${data.error}`, 'error');
                    responseEl.textContent = JSON.stringify(data, null, 2);
                }
            } catch (error) {
                showStatus('submitStatus', `‚úó Failed: ${error.message}`, 'error');
                responseEl.textContent = error.stack;
            }
        }

        async function testFetch() {
            const statusEl = document.getElementById('fetchStatus');
            const responseEl = document.getElementById('fetchResponse');

            const limit = parseInt(document.getElementById('fetchLimit').value);
            const playerName = document.getElementById('fetchPlayer').value.trim().toUpperCase();

            showStatus('fetchStatus', '‚è≥ Fetching...', 'info');
            responseEl.textContent = '';

            try {
                const baseUrl = getApiUrl();
                const url = new URL(`${baseUrl}/api/scores`);
                url.searchParams.set('limit', limit);
                if (playerName) {
                    url.searchParams.set('playerName', playerName);
                }

                const response = await fetch(url);
                const data = await response.json();

                if (response.ok) {
                    const count = data.globalTop?.length || 0;
                    showStatus('fetchStatus', `‚úì Fetched ${count} scores`, 'success');
                    responseEl.textContent = JSON.stringify(data, null, 2);
                } else {
                    showStatus('fetchStatus', `‚úó Error: ${response.status}`, 'error');
                    responseEl.textContent = JSON.stringify(data, null, 2);
                }
            } catch (error) {
                showStatus('fetchStatus', `‚úó Failed: ${error.message}`, 'error');
                responseEl.textContent = error.stack;
            }
        }

        async function showStats() {
            const statusEl = document.getElementById('statsStatus');
            const displayEl = document.getElementById('statsDisplay');

            showStatus('statsStatus', '‚è≥ Fetching stats...', 'info');
            displayEl.textContent = '';

            try {
                const baseUrl = getApiUrl();
                const response = await fetch(`${baseUrl}/api/scores?limit=50`);
                const data = await response.json();

                if (response.ok && data.stats) {
                    const stats = data.stats;
                    const topScores = data.globalTop || [];

                    let statsText = 'üìä DATABASE STATISTICS\n\n';
                    statsText += `Total Players: ${stats.totalPlayers}\n`;
                    statsText += `Total Scores: ${stats.totalScores}\n`;
                    statsText += `Avg Scores per Player: ${(stats.totalScores / stats.totalPlayers).toFixed(1)}\n\n`;

                    if (topScores.length > 0) {
                        statsText += 'üèÜ TOP PLAYERS:\n\n';
                        topScores.slice(0, 10).forEach(score => {
                            statsText += `#${score.rank} ${score.playerName.padEnd(12)} Level ${score.level} in ${score.timeElapsed}s\n`;
                        });
                    }

                    showStatus('statsStatus', '‚úì Stats loaded', 'success');
                    displayEl.textContent = statsText;
                } else {
                    showStatus('statsStatus', '‚úó Failed to load stats', 'error');
                    displayEl.textContent = JSON.stringify(data, null, 2);
                }
            } catch (error) {
                showStatus('statsStatus', `‚úó Failed: ${error.message}`, 'error');
                displayEl.textContent = error.stack;
            }
        }

        function showStatus(elementId, message, type) {
            const el = document.getElementById(elementId);
            el.className = `status ${type}`;
            el.textContent = message;
            el.style.display = 'block';
        }

        // Test on load
        window.addEventListener('load', () => {
            console.log('API Tester loaded');
            console.log('Configure your Worker URL and start testing!');
        });
    </script>
</body>
</html>
